<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard Kerja Borongan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: #f5f5f5;
        margin: 0;
        padding: 20px;
      }

      .container {
        max-width: 1000px;
        margin: auto;
        background: #fff;
        padding: 20px;
        border-radius: 12px;
      }

      h1 {
        text-align: center;
        color: #1e3c72;
      }

      /* Form input */
      .form {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
      }
      .form input,
      .form select,
      .form button {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        flex: 1 1 100%;
        box-sizing: border-box;
      }
      .form button {
        background: #1e3c72;
        color: #fff;
        cursor: pointer;
      }

      /* Table */
      .table-wrapper {
        overflow-x: auto;
        margin-top: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
      }
      th {
        background: #1e3c72;
        color: #fff;
        padding: 8px;
        font-size: 0.85rem;
        text-align: center;
      }
      td {
        padding: 6px;
        font-size: 0.8rem;
        text-align: center;
        border-bottom: 1px solid #eee;
      }
      tfoot td {
        font-weight: 600;
        background: #f0f0f0;
      }
      .btn-del {
        background: #e74c3c;
        color: #fff;
        padding: 4px 6px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      /* Motivasi */
      .motivasiPDF {
        margin-bottom: 10px;
        padding: 8px;
        border-radius: 6px;
        font-weight: 600;
        text-align: center;
      }
      .motivasiPDF.sukses {
        background: #e8fff4;
        color: #0c7c59;
        border: 2px solid #0c7c59;
      }
      .motivasiPDF.warning {
        background: #fff0f0;
        color: #c0392b;
        border: 2px solid #c0392b;
      }

      .btn-pdf {
        background: #0c7c59;
        color: #fff;
        width: 100%;
        padding: 10px;
        border: none;
        border-radius: 8px;
        margin-top: 15px;
        cursor: pointer;
      }

      /* Grafik */
      #chartContainer {
        margin-top: 25px;
        background: #fff;
        padding: 15px;
        border-radius: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸ“Š Dashboard Kerja Borongan</h1>

      <!-- Form input -->
      <div class="form">
        <input id="nama" placeholder="Nama" />
        <select id="ukuran">
          <option value="">Ukuran</option>
          <option data-harga="10.5">45â€“54 cm</option>
          <option data-harga="11.4">55â€“64 cm</option>
          <option data-harga="12.6">65â€“74 cm</option>
          <option data-harga="13.6">75â€“84 cm</option>
          <option data-harga="17">85â€“94 cm</option>
        </select>
        <input type="number" id="hasil" placeholder="Jumlah" />
        <button class="btn-add" onclick="tambah()">Tambah</button>
      </div>

      <!-- Motivasi -->
      <div id="motivasiPDF" class="motivasiPDF"></div>

      <!-- Tabel -->
      <div class="table-wrapper" id="areaTable">
        <table>
          <thead>
            <tr>
              <th>Tanggal</th>
              <th>Nama</th>
              <th>Ukuran</th>
              <th>Harga</th>
              <th>Jumlah</th>
              <th>Total</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="tabel"></tbody>
          <tfoot>
            <tr>
              <td colspan="5">Total Keseluruhan</td>
              <td id="totalKeseluruhan">Rp 0</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Tombol PDF -->
      <button class="btn-pdf" onclick="downloadPDF()">ðŸ“¥ Download PDF</button>

      <!-- Grafik -->
      <div id="chartContainer">
        <canvas id="chart"></canvas>
      </div>
    </div>

    <script>
      let data = JSON.parse(localStorage.getItem("borongan")) || [];

      const rupiah = (n) => "Rp " + Number(n).toLocaleString("id-ID");

      function hariTanggal(date) {
        const hari = [
          "Minggu",
          "Senin",
          "Selasa",
          "Rabu",
          "Kamis",
          "Jumat",
          "Sabtu",
        ];
        const bulan = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "Mei",
          "Jun",
          "Jul",
          "Agu",
          "Sep",
          "Okt",
          "Nov",
          "Des",
        ];
        const d = new Date(date);
        return `${hari[d.getDay()]}, ${d.getDate()} ${bulan[d.getMonth()]} ${d.getFullYear()}`;
      }

      function tambah() {
        if (!nama.value || !ukuran.value || !hasil.value) {
          alert("Lengkapi data");
          return;
        }
        const h = Number(ukuran.options[ukuran.selectedIndex].dataset.harga);
        const t = h * Number(hasil.value);
        const now = new Date();
        const tanggal = now.toISOString().slice(0, 10);
        data.push({
          nama: nama.value,
          tanggal,
          ukuran: ukuran.value,
          harga: h,
          hasil: Number(hasil.value),
          total: t,
        });
        localStorage.setItem("borongan", JSON.stringify(data));
        render();
        nama.value = "";
        ukuran.value = "";
        hasil.value = "";
      }

      function hapus(i) {
        data.splice(i, 1);
        localStorage.setItem("borongan", JSON.stringify(data));
        render();
      }

      function render() {
        // Render tabel
        tabel.innerHTML = "";
        let totalKeseluruhan = 0;
        data.forEach((d, i) => {
          totalKeseluruhan += d.total;
          tabel.innerHTML += `
          <tr>
            <td>${hariTanggal(d.tanggal)}</td>
            <td>${d.nama}</td>
            <td>${d.ukuran}</td>
            <td>${rupiah(d.harga)}</td>
            <td>${d.hasil}</td>
            <td>${rupiah(d.total)}</td>
            <td><button class="btn-del" onclick="hapus(${i})">Hapus</button></td>
          </tr>
        `;
        });
        document.getElementById("totalKeseluruhan").innerText =
          rupiah(totalKeseluruhan);

        // Motivasi harian & bulanan
        cekMotivasiPDF();

        // Grafik
        renderChart();
      }

      function cekMotivasiPDF() {
        const el = document.getElementById("motivasiPDF");

        // Kinerja harian
        const mapH = {};
        data.forEach(
          (d) => (mapH[d.tanggal] = (mapH[d.tanggal] || 0) + d.total),
        );
        const hariKeys = Object.keys(mapH).sort();

        // Kinerja bulanan
        const mapM = {};
        data.forEach((d) => {
          const m = d.tanggal.slice(0, 7);
          mapM[m] = (mapM[m] || 0) + d.total;
        });
        const bulanKeys = Object.keys(mapM).sort();

        let motivasiText = "";
        let className = "";

        // Harian
        if (hariKeys.length >= 2) {
          if (mapH[hariKeys.at(-1)] > mapH[hariKeys.at(-2)])
            motivasiText += "ðŸ”¥ Kinerja harian meningkat! ";
          else motivasiText += "âš ï¸ Kinerja harian menurun. ";
        }

        // Bulanan
        if (bulanKeys.length >= 2) {
          if (mapM[bulanKeys.at(-1)] > mapM[bulanKeys.at(-2)]) {
            motivasiText += "ðŸš€ Kinerja bulanan meningkat! ";
            motivasiText +=
              "Tetap hati-hati istirahat lah sebentar semangat, jangan sampai ngantuk atau kelelahan karena semangat kerja Kesehatan badan Lebih Penting Dari Segalanya. ðŸ’ª"; // tambahan
            className = "sukses";
          } else {
            motivasiText += "ðŸ“‰ Kinerja bulanan menurun!";
            className = "warning";
          }
        }

        if (motivasiText) {
          el.className = "motivasiPDF " + className;
          el.innerHTML = motivasiText;
          el.style.display = "block";
        } else el.style.display = "none";
      }

      function renderChart() {
        const ctx = document.getElementById("chart").getContext("2d");
        const map = {};
        data.forEach((d) => (map[d.tanggal] = (map[d.tanggal] || 0) + d.total));
        const labels = Object.keys(map).sort();
        const values = labels.map((k) => map[k]);

        if (window.myChart) window.myChart.destroy();
        window.myChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Total Harian",
                data: values,
                backgroundColor: "#1e3c72",
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } },
          },
        });
      }

      // Download PDF (hanya tabel + total)
      async function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("p", "mm", "a4");

        // Ambil tabel
        const table = document.querySelector("table").cloneNode(true);

        const tempDiv = document.createElement("div");
        tempDiv.style.background = "#fff";
        tempDiv.style.padding = "10px";
        tempDiv.appendChild(table);
        document.body.appendChild(tempDiv);

        const canvas = await html2canvas(tempDiv, { scale: 2 });
        const img = canvas.toDataURL("image/png");

        const w = 210;
        const h = (canvas.height * w) / canvas.width;
        pdf.addImage(img, "PNG", 0, 0, w, h);
        pdf.save("Laporan_Borongan_Tabel.pdf");

        document.body.removeChild(tempDiv);
      }

      render();
    </script>
  </body>
</html>
