<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard Kerja Borongan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
      body {
        font-family:
          Segoe UI,
          sans-serif;
        background: linear-gradient(135deg, #1e3c72, #2a5298);
        padding: 20px;
      }
      .container {
        max-width: 1200px;
        margin: auto;
        background: #fff;
        padding: 25px;
        border-radius: 16px;
      }
      h1,
      h2 {
        text-align: center;
        color: #1e3c72;
      }

      /* dashboard */
      .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 15px;
      }
      .card {
        background: linear-gradient(135deg, #0c7c59, #16a085);
        color: #fff;
        padding: 18px;
        border-radius: 14px;
      }
      .card span {
        font-size: 26px;
        font-weight: 700;
      }

      /* form */
      .form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }
      input,
      select,
      button {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
      }
      button {
        cursor: pointer;
      }
      .btn-add {
        background: #1e3c72;
        color: #fff;
      }
      .btn-del {
        background: #e74c3c;
        color: #fff;
      }
      .btn-pdf {
        background: #0c7c59;
        color: #fff;
        width: 100%;
        margin-top: 20px;
      }

      /* table */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th {
        background: #1e3c72;
        color: #fff;
        padding: 10px;
      }
      td {
        padding: 8px;
        border-bottom: 1px solid #eee;
        text-align: center;
      }

      /* summary */
      .summary {
        margin-top: 20px;
        background: linear-gradient(135deg, #1e3c72, #2a5298);
        color: #fff;
        padding: 15px;
        border-radius: 12px;
        display: flex;
        justify-content: space-between;
      }
      .summary span {
        font-size: 26px;
        font-weight: 700;
      }

      /* motivasi */
      .motivasi {
        margin-top: 15px;
        padding: 14px;
        border-radius: 10px;
        font-weight: 600;
        text-align: center;
        display: none;
      }
      .motivasi.sukses {
        background: #e8fff4;
        color: #0c7c59;
        border: 2px solid #0c7c59;
      }
      .motivasi.warning {
        background: #fff0f0;
        color: #c0392b;
        border: 2px solid #c0392b;
      }

      canvas {
        margin-top: 20px;
      }
    </style>
  </head>

  <body>
    <!-- AREA PDF -->
    <div class="container" id="areaPDF">
      <h1>ðŸ“Š Dashboard Kerja Borongan</h1>

      <div class="dashboard">
        <div class="card">
          <h4>Total Pendapatan</h4>
          <span id="dTotal">Rp 0</span>
        </div>
        <div class="card">
          <h4>Hari Ini</h4>
          <span id="dHari">Rp 0</span>
        </div>
        <div class="card">
          <h4>Bulan Ini</h4>
          <span id="dBulan">Rp 0</span>
        </div>
        <div class="card">
          <h4>Total Data</h4>
          <span id="dData">0</span>
        </div>
      </div>

      <div class="form">
        <input id="nama" placeholder="Nama" />
        <input type="date" id="tanggal" />
        <select id="ukuran">
          <option value="">Ukuran</option>
          <option data-harga="10.5">45â€“54 cm</option>
          <option data-harga="11.4">55â€“64 cm</option>
          <option data-harga="12.6">65â€“74 cm</option>
          <option data-harga="13.6">75â€“84 cm</option>
          <option data-harga="17">85â€“94 cm</option>
        </select>
        <input id="harga" readonly placeholder="Harga" />
        <input type="number" id="hasil" placeholder="Jumlah" />
        <input id="total" readonly placeholder="Total" />
        <button class="btn-add" onclick="tambah()">Tambah</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Tanggal</th>
            <th>Nama</th>
            <th>Ukuran</th>
            <th>Harga</th>
            <th>Jumlah</th>
            <th>Total</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="tabel"></tbody>
      </table>

      <div class="summary">
        <h3>Total Keseluruhan</h3>
        <span id="grand">Rp 0</span>
      </div>

      <div id="motivasiHarian" class="motivasi"></div>
      <div id="motivasiBulanan" class="motivasi"></div>

      <h2>ðŸ“ˆ Grafik Pendapatan</h2>
      <canvas id="grafikHarian"></canvas>
      <canvas id="grafikBulanan"></canvas>
    </div>

    <button class="btn-pdf" onclick="downloadPDF()">ðŸ“¥ Download PDF</button>

    <script>
      let data = JSON.parse(localStorage.getItem("borongan")) || [];
      let chHarian, chBulanan;
      const rupiah = (n) => "Rp " + Number(n).toLocaleString("id-ID");

      ukuran.onchange = () => {
        const h = ukuran.options[ukuran.selectedIndex]?.dataset.harga || 0;
        harga.value = rupiah(h);
        hitung();
      };
      hasil.oninput = hitung;

      function hitung() {
        const h = ukuran.options[ukuran.selectedIndex]?.dataset.harga || 0;
        total.value = rupiah(h * hasil.value);
      }

      function tambah() {
        if (!nama.value || !tanggal.value || !ukuran.value || !hasil.value) {
          alert("Lengkapi data");
          return;
        }
        const h = Number(ukuran.options[ukuran.selectedIndex].dataset.harga);
        const t = h * hasil.value;

        data.push({
          nama: nama.value,
          tanggal: tanggal.value,
          bulan: tanggal.value.slice(0, 7),
          ukuran: ukuran.value,
          harga: h,
          hasil: hasil.value,
          total: t,
        });

        localStorage.setItem("borongan", JSON.stringify(data));
        render();
        document.querySelectorAll("input").forEach((i) => (i.value = ""));
        ukuran.value = "";
      }

      function hapus(i) {
        data.splice(i, 1);
        localStorage.setItem("borongan", JSON.stringify(data));
        render();
      }

      function render() {
        tabel.innerHTML = "";
        let gt = 0,
          hari = 0,
          bulan = 0;
        const today = new Date().toISOString().slice(0, 10);
        const bln = today.slice(0, 7);

        data.forEach((d, i) => {
          gt += d.total;
          if (d.tanggal === today) hari += d.total;
          if (d.bulan === bln) bulan += d.total;

          tabel.innerHTML += `
    <tr>
      <td>${d.tanggal}</td>
      <td>${d.nama}</td>
      <td>${d.ukuran}</td>
      <td>${rupiah(d.harga)}</td>
      <td>${d.hasil}</td>
      <td>${rupiah(d.total)}</td>
      <td><button class="btn-del" onclick="hapus(${i})">Hapus</button></td>
    </tr>`;
        });

        grand.innerText = rupiah(gt);
        dTotal.innerText = rupiah(gt);
        dHari.innerText = rupiah(hari);
        dBulan.innerText = rupiah(bulan);
        dData.innerText = data.length;

        grafik();
        cekMotivasi();
      }

      function grafik() {
        const h = {},
          b = {};
        data.forEach((d) => {
          h[d.tanggal] = (h[d.tanggal] || 0) + d.total;
          b[d.bulan] = (b[d.bulan] || 0) + d.total;
        });

        if (chHarian) chHarian.destroy();
        if (chBulanan) chBulanan.destroy();

        chHarian = new Chart(grafikHarian, {
          type: "bar",
          data: {
            labels: Object.keys(h),
            datasets: [
              {
                label: "Harian",
                data: Object.values(h),
                backgroundColor: "#1e3c72",
              },
            ],
          },
        });

        chBulanan = new Chart(grafikBulanan, {
          type: "line",
          data: {
            labels: Object.keys(b),
            datasets: [
              {
                label: "Bulanan",
                data: Object.values(b),
                borderColor: "#0c7c59",
                fill: true,
                tension: 0.4,
              },
            ],
          },
        });
      }

      /* ===== MOTIVASI ===== */
      function cekMotivasi() {
        cekHarian();
        cekBulanan();
      }

      function cekHarian() {
        const map = {};
        data.forEach((d) => (map[d.tanggal] = (map[d.tanggal] || 0) + d.total));
        const k = Object.keys(map).sort();
        if (k.length < 2) return;

        const el = document.getElementById("motivasiHarian");
        el.style.display = "block";

        if (map[k.at(-1)] > map[k.at(-2)]) {
          el.className = "motivasi sukses";
          el.innerHTML =
            "ðŸ”¥ Kinerja harian meningkat! Pertahankan semangat kerja ðŸ’ª";
        } else {
          el.className = "motivasi warning";
          el.innerHTML =
            "âš ï¸ Kinerja harian menurun. Evaluasi dan bangkit besok ðŸ’ª";
        }
      }

      function cekBulanan() {
        const map = {};
        data.forEach((d) => (map[d.bulan] = (map[d.bulan] || 0) + d.total));
        const k = Object.keys(map).sort();
        if (k.length < 2) return;

        const el = document.getElementById("motivasiBulanan");
        el.style.display = "block";

        if (map[k.at(-1)] > map[k.at(-2)]) {
          el.className = "motivasi sukses";
          el.innerHTML =
            "ðŸ† Bulan ini lebih baik dari bulan lalu! Kerja kerasmu terbukti ðŸ‘";
        } else {
          el.className = "motivasi warning";
          el.innerHTML =
            "âš ï¸ Pendapatan bulanan menurun. Tetapkan target baru ðŸš€";
        }
      }

      /* ===== PDF ===== */
      async function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("p", "mm", "a4");

        const canvas = await html2canvas(document.getElementById("areaPDF"), {
          scale: 2,
        });
        const img = canvas.toDataURL("image/png");

        const w = 210;
        const h = (canvas.height * w) / canvas.width;
        let y = 0,
          sisa = h;

        pdf.addImage(img, "PNG", 0, y, w, h);
        sisa -= 297;

        while (sisa > 0) {
          y -= 297;
          pdf.addPage();
          pdf.addImage(img, "PNG", 0, y, w, h);
          sisa -= 297;
        }

        pdf.save("Laporan_Kerja_Borongan.pdf");
      }

      render();
    </script>
  </body>
</html>
